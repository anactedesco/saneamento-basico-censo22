---
title: "Saneamento básico - esgoto sanitário em 2022"
author: "Ana Tedesco"
date: "2024-03-26"
output: html_document
---

Nesse arquivo, apresentamos o código com breves comentários sobre a pauta publicada em 24 de março de 2024, no blog Abelardo Luz em dados!, a respeito da classificação do esgotamento sanitário no município de Abelardo Luz, no oeste de Santa Catarina.

Neste mesmo repositório, há outro arquivo .Rmd com os códigos e também breves comentários a respeito do tratamento de dados para a variável de esgotamento sanitário nos Censos de 2010 e 2000 (vale a leitura!).

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

```{r prel, include=TRUE, echo=TRUE}
rm(list=ls(all=TRUE))

library(censobr)
library(arrow)
library(dplyr)
library(ggplot2)
library(readxl)
library(tidyverse)
library(janitor) 


options(scipen = 99999)
```

### 2022

Diferentemente do que fizemos para os Censos de 2010 e 2000, para 2022, vamos utilizar um arquivo da máquina local, ou seja, vamos tratar os dados após realizar o download do arquivo de dados no site do IBGE.

Em seguida, listamos as informações presentes neste arquivo.

```{r tblst0, include = FALSE}
# Definir o caminho para os arquivos
caminho <- "C:/Users/ana.tedesco/Documents/Ana/Curiosidades/Censo/"
```

```{r tbls0, include = TRUE}
# Lendo o arquivo - você pode encontrá-lo no mesmo repositório deste Rmd
esgoto_sc <- read_excel(paste0(caminho, "esgoto_sc.xlsx"))
colnames(esgoto_sc)
```


Criamos então diferentes dataframes para nossas principais unidades de interesse de análise:

  - Abelardo Luz;
  - Municípios que fazem fronteira terrestre com Abelardo Luz;
  - Municípios que pertencem à microrregião da AMAI; e
  - Municípios que pertencem à mesorregião do Oeste de Santa Catarina.

```{r tbls, include = TRUE}
# Filtrar os Municipios desejados
abelardo <- subset(esgoto_sc, grepl("\\(SC\\)$", Município) & 
                      Município %in% c("Abelardo Luz (SC)"))
                                       
fronteira <- subset(esgoto_sc, grepl("\\(SC\\)$", Município) & 
                      Município %in% c("São Domingos (SC)", "Ipuaçu (SC)", "Bom Jesus (SC)",
                                  "Ouro Verde (SC)", "Faxinal dos Guedes (SC)", 
                                  "Vargeão (SC)", "Passos Maia (SC)"))

amai <- subset(esgoto_sc, grepl("\\(SC\\)$", Município) & 
                 Município %in% c("Abelardo Luz (SC)", "Bom Jesus (SC)", "Entre Rios (SC)", 
                          "Faxinal dos Guedes (SC)", "Ipuaçu (SC)", "Lajeado Grande (SC)", 
                          "Marema (SC)", "Ouro Verde (SC)", "Passos Maia (SC)", 
                          "Ponte Serrada (SC)", "São Domingos (SC)", "Vargeão (SC)", 
                          "Xanxerê (SC)", "Xaxim (SC)"))

oeste_sc <- subset(esgoto_sc, grepl("\\(SC\\)$", Município) & 
                     Município %in% c("Abelardo Luz (SC)", "Água Doce (SC)", "Águas de Chapecó (SC)", "Águas Frias (SC)", "Alto Bela Vista (SC)", "Anchieta (SC)", "Arabutã (SC)", "Arroio Trinta (SC)", "Arvoredo (SC)", "Bandeirante (SC)", "Barra Bonita (SC)", "Belmonte (SC)","Bom Jesus (SC)", "Bom Jesus do Oeste (SC)", "Caçador (SC)", "Caibi (SC)", "Calmon (SC)", "Campo Erê (SC)", "Capinzal (SC)", "Catanduvas (SC)", "Caxambu do Sul (SC)", "Chapecó (SC)", "Concórdia (SC)", "Cordilheira Alta (SC)", "Coronel Freitas (SC)", "Coronel Martins (SC)", "Cunha Porã (SC)", "Cunhataí (SC)", "Descanso (SC)", "Dionísio Cerqueira (SC)", "Entre Rios (SC)", "Erval Velho (SC)", "Faxinal dos Guedes (SC)", "Flor do Sertão (SC)", "Formosa do Sul (SC)", "Fraiburgo (SC)", "Galvão (SC)", "Guaraciaba (SC)", "Guarujá do Sul (SC)", "Guatambu (SC)", "Herval d'Oeste (SC)", "Ibiam (SC)", "Ibicaré (SC)", "Iomerê (SC)", "Ipira (SC)", "Iporã do Oeste (SC)", "Ipuaçu (SC)", "Ipumirim (SC)", "Iraceminha (SC)", "Irani (SC)", "Irati (SC)", "Itá (SC)", "Itapiranga (SC)", "Jaborá (SC)", "Jardinópolis (SC)", "Joaçaba (SC)", "Jupiá (SC)", "Lacerdópolis (SC)", "Lajeado Grande (SC)", "Lebon Régis (SC)", "Lindóia do Sul (SC)", "Luzerna (SC)", "Macieira (SC)", "Maravilha (SC)", "Marema (SC)", "Matos Costa (SC)",  "Modelo (SC)", "Mondaí (SC)", "Nova Erechim (SC)", "Nova Itaberaba (SC)", "Novo Horizonte (SC)", "Ouro (SC)", "Ouro Verde (SC)", "Paial (SC)", "Palma Sola (SC)", "Palmitos (SC)", "Paraíso (SC)", "Passos Maia (SC)", "Peritiba (SC)", "Pinhalzinho (SC)", "Pinheiro Preto (SC)", "Piratuba (SC)", "Planalto Alegre (SC)", "Ponte Serrada (SC)", "Presidente Castello Branco (SC)", "Princesa (SC)", "Quilombo (SC)", "Rio das Antas (SC)", "Riqueza (SC)", "Romelândia (SC)", "Saltinho (SC)", "Salto Veloso (SC)", "Santa Helena (SC)", "Santa Terezinha do Progresso (SC)", "Santiago do Sul (SC)", "São Bernardino (SC)","São Carlos (SC)", "São Domingos (SC)", "São João do Oeste (SC)", "São José do Cedro (SC)", "São Lourenço do Oeste (SC)", "São Miguel da Boa Vista (SC)", "São Miguel do Oeste (SC)", "Saudades (SC)", "Seara (SC)", "Serra Alta (SC)", "Sul Brasil (SC)", "Tangará (SC)", "Tigrinhos (SC)", "Treze Tílias (SC)", "Tunápolis (SC)", "União do Oeste (SC)", "Vargeão (SC)", "Vargem Bonita (SC)", "Videira (SC)", "Xanxerê (SC)", "Xavantina (SC)", "Xaxim (SC)"))
```

##### Classificação entre adequado, inadequado e sem esgoto sanitário

Apesar de essas tipologias de esgotamento serem interessantes, são pouco informativas a respeito do que é recomendado para evitar a transmissão de diversas doenças que se propagam pelo esgoto. Assim, Landau, Moura e Luz (2016) propuseram uma classificação a partir das opções fornecidas pelo IBGE, em que os tipos de tratamento de esgoto foram classificados como Adequado, Inadequado, e Sem esgoto sanitário.

Nessa classificação, os esgotamentos sanitários são considerados:

    - Adequado, se foram:
      - Rede geral de esgoto ou pluvial; 
      - Rede geral, rede pluvial ou fossa ligada à rede; 
      - Fossa séptica ou fossa filtro ligada à rede; e
      - Fossa séptica ou fossa filtro não ligada à rede.
      
    - Inadequado, se foram:
      - Fossa rudimentar ou buraco;
      - Vala; e
      - Rio, lago, córrego ou mar.
      
    - Outro tipo, no caso de:
      - Outra forma; e 
      - Não tinham banheiro nem sanitário.

Criamos então uma função que gera essa classificação automatizamente.

```{r tbls_1, include = TRUE}
# Função para aplicar as transformações e classificações
transforma_e_classifica <- function(df) {
  df %>%
    mutate(across(`Rede geral, rede pluvial ou fossa ligada à rede`:`Não tinham banheiro nem sanitário`, 
                  ~as.numeric(.))) %>%
    mutate(
      Adequado = `Rede geral, rede pluvial ou fossa ligada à rede` + `Rede geral ou pluvial` +
        `Fossa séptica ou fossa filtro ligada à rede` +`Fossa séptica ou fossa filtro não ligada à rede`,
      Inadequado = `Fossa rudimentar ou buraco` +
        Vala + `Rio, lago, córrego ou mar`,
      `Outro tipo` = `Outra forma` + `Não tinham banheiro nem sanitário`
    ) %>%
    pivot_longer(
      cols = c(Adequado, Inadequado, `Outro tipo`),
      names_to = "Classificacao",
      values_to = "count"
    ) %>%
    filter(count > 0) %>%
    group_by(Classificacao) %>%
    summarise(total = sum(count), .groups = 'drop') %>%
    mutate(percentage = (total / sum(total)) * 100)
}
```

Criamos então uma função que gera essa classificação automatizamente. Em seguida, aplicamos a função para os dataframes que criamos anteriormente.

```{r tbls_2, include = TRUE}
# Aplicando a função aos dataframes
abelardo_summary <- transforma_e_classifica(abelardo)
fronteira_summary <- transforma_e_classifica(fronteira)
amai_summary <- transforma_e_classifica(amai)
oeste_sc_summary <- transforma_e_classifica(oeste_sc)
esgoto_sc_summary <- transforma_e_classifica(esgoto_sc)
```

###### Resultados 2022

Passamos então para os resultados iniciais, primeiro para Abelardo Luz, seguido da média dos municípios que fazem fronteira terrrestre com Abelardo Luz, em seguida para a média dos municípios da AMAI, depois para a média dos municípios do Oeste de Santa Catarina, e, por fim, para a média de todos os municípios do estado de Santa Catarina.

```{r tbls_3, include = TRUE}
#Imprimido resultados
print(abelardo_summary)
print(fronteira_summary)
print(amai_summary)
print(oeste_sc_summary)
print(esgoto_sc_summary)
```

Notamos o resultado ruim para Abelardo Luz em perspectiva com as demais unidades de análise, o que nos leva a querer saber quais são os piores municípios do estado de Santa Catarina em termos de esgotamento sanitário. 

```{r tbls_4, include = TRUE}
#Ranking dos municípios
transforma_e_classifica_percents <- function(df) {
  df %>%
    mutate(across(`Rede geral, rede pluvial ou fossa ligada à rede`:`Não tinham banheiro nem sanitário`, 
                  ~as.numeric(.))) %>%
    mutate(
      Adequado = `Rede geral, rede pluvial ou fossa ligada à rede` + `Rede geral ou pluvial` +
        `Fossa séptica ou fossa filtro ligada à rede` + `Fossa séptica ou fossa filtro não ligada à rede`,
      Inadequado = `Fossa rudimentar ou buraco` + Vala + `Rio, lago, córrego ou mar`,
      `Outro tipo` = `Outra forma` + `Não tinham banheiro nem sanitário`,
      Total_Classificado = Adequado + Inadequado + `Outro tipo`,
      Percent_Inadequado = (Inadequado / Total_Classificado) * 100,
      Percent_Adequado = (Adequado / Total_Classificado) *100
    ) %>%
    select(Município, Adequado, Inadequado, `Outro tipo`, Total_Classificado, Percent_Inadequado, Percent_Adequado)
}

esgoto_sc_classificado <- transforma_e_classifica_percents(esgoto_sc)
```

O resultado é expresso abaixo, em que podemos ver Abelardo Luz ocupando o inglório terceiro lugar no top 3.

```{r tbls_5, include = TRUE}
#Imprimido resultados
top10_percent_inadequado <- esgoto_sc_classificado %>%
  arrange(desc(Percent_Inadequado)) %>%
  top_n(10, Percent_Inadequado) %>%
  select(Município, Percent_Inadequado, Percent_Adequado)
print(top10_percent_inadequado, n = 10, width = Inf)
```

Como a curiosidade é grande, resolvemos apresentar também o top 10 do outro extremo, ou seja, os municípios com maior proporção de esgotamento sanitário adequado. O resultado segue abaixo.

```{r tbls_6, include = TRUE}
#Imprimido resultados
top10_percent_adequado <- esgoto_sc_classificado %>%
  arrange(desc(Percent_Adequado)) %>%
  top_n(10, Percent_Adequado) %>%
  select(Município, Percent_Inadequado, Percent_Adequado)
print(top10_percent_adequado, n = 10, width = Inf)
```